/**
 * Created by Jack on 2018/8/31.
 */

/**
 * FUNCTION: pcorr( arr1[, arr2,...] )
 *	Computes Pearson product-moment correlation coefficients between one or more numeric arrays.
 *
 * @param {...Array} arr - numeric array
 * @returns {Array} correlation matrix
 */
function pcorr() {
	var args,
		nArgs,
		len,
		deltas,
		delta,
		means,
		stdevs,
		C,
		cov,
		corr,
		arr,
		N, r, A, B, sum, val, sigma,
		i, j, n;

	args = Array.prototype.slice.call( arguments );
	nArgs = args.length;

	if ( !nArgs ) {
		throw new Error( 'pcorr()::insufficient input arguments. Must provide array arguments.' );
	}
	for ( i = 0; i < nArgs; i++ ) {
		if ( !Array.isArray( args[i] ) ) {
			throw new TypeError( 'pcorr()::invalid input argument. Must provide array arguments.' );
		}
	}
	if ( Array.isArray( args[0][0] ) ) {
		// If the first argument is an array of arrays, calculate the correlation matrix over the nested arrays, disregarding any other arguments...
		args = args[ 0 ];
	}
	nArgs = args.length;
	len = args[ 0 ].length;
	for ( i = 1; i < nArgs; i++ ) {
		if ( args[i].length !== len ) {
			throw new Error( 'pcorr()::invalid input argument. All arrays must have equal length.' );
		}
	}
	// [0] Initialization...
	deltas = new Array( nArgs );
	means = new Array( nArgs );
	stdevs = new Array( nArgs );
	C = new Array( nArgs );
	cov = new Array( nArgs );
	corr = new Array( nArgs );
	for ( i = 0; i < nArgs; i++ ) {
		means[ i ] = args[ i ][ 0 ];
		arr = new Array( nArgs );
		for ( j = 0; j < nArgs; j++ ) {
			arr[ j ] = 0;
		}
		C[ i ] = arr;
		cov[ i ] = arr.slice(); // copy!
		corr[ i ] = arr.slice(); // copy!
	}
	if ( len < 2 ) {
		return corr;
	}
	// [1] Compute the covariance...
	for ( n = 1; n < len; n++ ) {

		N = n + 1;
		r = n / N;

		// [a] Extract the values and compute the deltas...
		for ( i = 0; i < nArgs; i++ ) {
			deltas[ i ] = args[ i ][ n ] - means[ i ];
		}

		// [b] Update the covariance between one array and every other array...
		for ( i = 0; i < nArgs; i++ ) {
			arr = C[ i ];
			delta = deltas[ i ];
			for ( j = i; j < nArgs; j++ ) {
				A = arr[ j ];
				B = r * delta * deltas[ j ];
				sum = A + B;
				// Exploit the fact that the covariance matrix is symmetric...
				if ( i !== j ) {
					C[ j ][ i ] = sum;
				}
				arr[ j ] = sum;
			} // end FOR j
		} // end FOR i

		// [c] Update the means...
		for ( i = 0; i < nArgs; i++ ) {
			means[ i ] += deltas[ i ] / N;
		}
	} // end FOR n

	// [2] Normalize the co-moments...
	n = N - 1;
	for ( i = 0; i < nArgs; i++ ) {
		arr = C[ i ];
		for ( j = i; j < nArgs; j++ ) {
			val = arr[ j ] / n;
			cov[ i ][ j ] = val;
			if ( i !== j ) {
				cov[ j ][ i ] = val;
			}
		}
	}

	// [3] Compute the standard deviations...
	for ( i = 0; i < nArgs; i++ ) {
		// Diagonal elements of covariance matrix...
		stdevs[ i ] = Math.sqrt( cov[i][i] );
	}

	// [4] Set the diagonal elements to 1:
	for ( i = 0; i < nArgs; i++ ) {
		corr[ i ][ i ] = 1;
	}

	// [5] Compute the correlation coefficients...
	for ( i = 0; i < nArgs; i++ ) {
		arr = cov[ i ];
		sigma = stdevs[ i ];
		for ( j = i+1; j < nArgs; j++ ) {
			val = arr[ j ] / ( sigma*stdevs[j] );
			// Address floating point errors introduced by taking the sqrt and enforce strict [-1,1] bounds...
			if ( val > 1 ) {
				val = 1;
			} else if ( val < -1 ) {
				val = -1;
			}
			corr[ i ][ j ] = val;
			corr[ j ][ i ] = val;
		}
	}
	return corr;
} // end FUNCTION pcorr()

function sub_sort(array, low, high) {
    let key = array[low];
    while (low < high) {
        while(low < high && array[high].score <= key.score)
            high --;
        array[low] = array[high];
        while(low < high && array[high].score > key.score)
        	low ++;
        array[high] = array[low];
	}
    array[low] = key;
    return low;
}

/**
 * quicksort
 * big to small
 * @param arr
 * @returns {*}
 */
function quickSort(arr, low, high){
    if(low < high) {
    	console.log(arr);
        key_index = sub_sort(arr, low, high);
        quickSort(arr, low, key_index);
        quickSort(arr, key_index + 1, high);
	}
}

// function test() {
// 	vector1 = [38.24087092738347, 38.24087092738347, 38.24087092738347, 38.24087092738347, 38.24087092738347, 38.24087092738347, 38.24087092738347, 38.24087092738347, 38.24087092738347, 36.31800709584261, 36.31800709584261, 36.31800709584261, 36.31800709584261, 36.31800709584261, 36.31800709584261, 36.31800709584261, 36.31800709584261, 36.31800709584261, 36.31800709584261, 36.31800709584261, 36.31800709584261, 36.31800709584261, 36.31800709584261, 36.31800709584261, 36.938852013359075, 36.938852013359075, 36.938852013359075, 36.938852013359075, 36.938852013359075, 36.938852013359075, 36.938852013359075, 36.938852013359075, 36.938852013359075, 36.938852013359075, 36.938852013359075, 36.938852013359075, 36.938852013359075, 36.938852013359075, 36.938852013359075, 28.110090389090836, 28.110090389090836, 28.110090389090836, 28.110090389090836, 28.110090389090836, 28.110090389090836, 28.110090389090836, 28.110090389090836, 28.110090389090836, 28.110090389090836, 28.110090389090836, 28.110090389090836, 28.110090389090836, 28.110090389090836, 28.110090389090836, 20.483391963903863, 20.483391963903863, 20.483391963903863, 20.483391963903863, 20.483391963903863, 20.483391963903863, 20.483391963903863, 20.483391963903863, 20.483391963903863, 20.483391963903863, 20.483391963903863, 20.483391963903863, 20.483391963903863, 20.483391963903863, 20.483391963903863, 13.676102194406134, 13.676102194406134, 13.676102194406134, 13.676102194406134, 13.676102194406134, 13.676102194406134, 13.676102194406134, 13.676102194406134, 13.676102194406134, 13.676102194406134, 13.676102194406134, 13.676102194406134, 13.676102194406134, 13.676102194406134, 13.676102194406134, 10.64384253207099, 10.64384253207099, 10.64384253207099, 10.64384253207099, 10.64384253207099, 10.64384253207099, 10.64384253207099, 10.64384253207099, 10.64384253207099, 10.64384253207099, 10.64384253207099, 10.64384253207099, 10.64384253207099, 10.64384253207099, 10.64384253207099, 10.349608314783637];
// 	vector2 = [1.6414290234720104, 1.6414290234720104, 1.6414290234720104, 1.6414290234720104, 1.7808990195309697, 1.7808990195309697, 1.7808990195309697, 1.7808990195309697, 1.7808990195309697, 1.7808990195309697, 1.7808990195309697, 1.7808990195309697, 1.7808990195309697, 1.7808990195309697, 1.7808990195309697, 1.7808990195309697, 1.7808990195309697, 1.7808990195309697, 1.7808990195309697, 1.7916500980390504, 1.7916500980390504, 1.7916500980390504, 1.7916500980390504, 1.7916500980390504, 1.7916500980390504, 1.7916500980390504, 1.7916500980390504, 1.7916500980390504, 1.7916500980390504, 1.7916500980390504, 1.7916500980390504, 1.7916500980390504, 1.7916500980390504, 1.7916500980390504, 1.8165664112897815, 1.8165664112897815, 1.8165664112897815, 1.8165664112897815, 1.8165664112897815, 1.8165664112897815, 1.8165664112897815, 1.8165664112897815, 1.8165664112897815, 1.8165664112897815, 1.8165664112897815, 1.8165664112897815, 1.8165664112897815, 1.8165664112897815, 1.8165664112897815, 1.8084125490911163, 1.8084125490911163, 1.8084125490911163, 1.8084125490911163, 1.8084125490911163, 1.8084125490911163, 1.8084125490911163, 1.8084125490911163, 1.8084125490911163, 1.8084125490911163, 1.8084125490911163, 1.8084125490911163, 1.8084125490911163, 1.8084125490911163, 1.8084125490911163, 1.7669547515723942, 1.7669547515723942, 1.7669547515723942, 1.7669547515723942, 1.7669547515723942, 1.7669547515723942, 1.7669547515723942, 1.7669547515723942, 1.7669547515723942, 1.7669547515723942, 1.7669547515723942, 1.7669547515723942, 1.7669547515723942, 1.7669547515723942, 1.7669547515723942, 1.74522336458303, 1.74522336458303, 1.74522336458303, 1.74522336458303, 1.74522336458303, 1.74522336458303, 1.74522336458303, 1.74522336458303, 1.74522336458303, 1.74522336458303, 1.74522336458303, 1.74522336458303, 1.74522336458303, 1.74522336458303, 1.74522336458303, 1.6733406545452503, 1.6733406545452503, 1.6733406545452503, 1.6733406545452503, 1.6733406545452503, 1.6733406545452503];
// 	vector3 = [8.853917841329691, 8.853917841329691, 8.853917841329691, 8.853917841329691, 8.853917841329691, 8.853917841329691, 8.770435362742965, 8.770435362742965, 8.770435362742965, 8.770435362742965, 8.770435362742965, 8.770435362742965, 8.770435362742965, 8.770435362742965, 8.770435362742965, 8.770435362742965, 8.770435362742965, 8.770435362742965, 8.770435362742965, 8.770435362742965, 8.770435362742965, 8.788540035332048, 8.788540035332048, 8.788540035332048, 8.788540035332048, 8.788540035332048, 8.788540035332048, 8.788540035332048, 8.788540035332048, 8.788540035332048, 8.788540035332048, 8.788540035332048, 8.788540035332048, 8.788540035332048, 8.788540035332048, 8.788540035332048, 9.079303584966764, 9.079303584966764, 9.079303584966764, 9.079303584966764, 9.079303584966764, 9.079303584966764, 9.079303584966764, 9.079303584966764, 9.079303584966764, 9.079303584966764, 9.079303584966764, 9.079303584966764, 9.079303584966764, 9.079303584966764, 9.079303584966764, 8.822486141179924, 8.822486141179924, 8.822486141179924, 8.822486141179924, 8.822486141179924, 8.822486141179924, 8.822486141179924, 8.822486141179924, 8.822486141179924, 8.822486141179924, 8.822486141179924, 8.822486141179924, 8.822486141179924, 8.822486141179924, 8.822486141179924, 9.418534542202435, 9.418534542202435, 9.418534542202435, 9.418534542202435, 9.418534542202435, 9.418534542202435, 9.418534542202435, 9.418534542202435, 9.418534542202435, 9.418534542202435, 9.418534542202435, 9.418534542202435, 9.418534542202435, 9.418534542202435, 9.418534542202435, 9.049963484694782, 9.049963484694782, 9.049963484694782, 9.049963484694782, 9.049963484694782, 9.049963484694782, 9.049963484694782, 9.049963484694782, 9.049963484694782, 9.049963484694782, 9.049963484694782, 9.049963484694782, 9.049963484694782, 9.049963484694782, 9.049963484694782, 9.455788311652, 9.455788311652, 9.455788311652, 9.455788311652];
// 	vector4 = [27.30165344441578, 27.30165344441578, 27.30165344441578, 27.30165344441578, 27.30165344441578, 27.30165344441578, 27.30165344441578, 27.30165344441578, 27.30165344441578, 27.30165344441578, 27.30165344441578, 27.30165344441578, 27.30165344441578, 27.30165344441578, 27.307753095231288, 27.307753095231288, 27.307753095231288, 27.307753095231288, 27.307753095231288, 27.307753095231288, 27.307753095231288, 27.307753095231288, 27.307753095231288, 27.307753095231288, 27.307753095231288, 27.307753095231288, 27.307753095231288, 27.307753095231288, 27.307753095231288, 26.664944512498316, 26.664944512498316, 26.664944512498316, 26.664944512498316, 26.664944512498316, 26.664944512498316, 26.664944512498316, 26.66494451249832, 26.66494451249832, 26.66494451249832, 26.66494451249832, 26.66494451249832, 26.66494451249832, 26.66494451249832, 26.66494451249832, 28.99945105063804, 28.99945105063804, 28.99945105063804, 28.99945105063804, 28.99945105063804, 28.99945105063804, 28.99945105063804, 28.99945105063804, 28.99945105063804, 28.99945105063804, 28.99945105063804, 28.99945105063804, 28.99945105063804, 28.99945105063804, 28.99945105063804, 27.911156770279693, 27.911156770279693, 27.911156770279693, 27.911156770279693, 27.911156770279693, 27.911156770279693, 27.911156770279693, 27.911156770279693, 27.911156770279693, 27.911156770279693, 27.911156770279693, 27.911156770279693, 27.911156770279693, 27.911156770279693, 27.911156770279693, 26.566034613339678, 26.566034613339678, 26.566034613339678, 26.566034613339678, 26.566034613339678, 26.566034613339678, 26.566034613339678, 26.566034613339678, 26.566034613339678, 26.566034613339678, 26.566034613339678, 26.566034613339678, 26.566034613339678, 26.566034613339678, 26.566034613339678, 26.560546311695553, 26.560546311695553, 26.560546311695553, 26.560546311695553, 26.560546311695553, 26.560546311695553, 26.560546311695553, 26.560546311695553, 26.560546311695553, 26.560546311695553, 26.560546311695553];
// 	vector = [];
// 	vector.push(vector1);
// 	vector.push(vector2);
// 	vector.push(vector3);
// 	vector.push(vector4);
// 	mat = pcorr(vector);
// 	console.log(mat);
// }

